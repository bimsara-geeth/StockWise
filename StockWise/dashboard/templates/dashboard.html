{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Colombo Stock Exchange — Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Popup modals, FAB menu, and extra animations -->
    <style>
    /* modal / overlay */
    .modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:1200;transition:opacity .25s ease}
    .modal-overlay.show{display:flex;opacity:1}
    .modal{background:var(--card);border-radius:12px;padding:18px;width:420px;max-width:94%;box-shadow:0 12px 40px rgba(2,6,23,.7);transform:translateY(18px) scale(.98);opacity:0;transition:transform .28s cubic-bezier(.2,.9,.3,1),opacity .22s}
    .modal.show{transform:translateY(0) scale(1);opacity:1}
    .modal h4{margin:0 0 8px 0}
    .modal .row{display:flex;gap:8px;margin:8px 0}
    .modal label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    .input, .select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btn-ghost-small{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--muted);cursor:pointer}
    .btn-confirm{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#012;cursor:pointer}

    /* Floating action menu */
    .fab-wrap{position:fixed;right:20px;bottom:26px;z-index:1100;display:flex;flex-direction:column;align-items:flex-end;gap:10px}
    .fab-main{width:54px;height:54px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#012;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(0,194,168,0.12);border:none}
    .fab-mini{min-width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;color:var(--muted);cursor:pointer;border:none;padding:0 10px;font-weight:600;transform:translateY(8px);opacity:0;transition:transform .18s cubic-bezier(.2,.9,.3,1),opacity .18s}
    .fab-open .fab-mini{transform:translateY(0);opacity:1}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:90px;background:rgba(255,255,255,0.04);padding:10px 14px;border-radius:10px;color:var(--muted);box-shadow:0 8px 30px rgba(2,6,23,.6);z-index:1300;opacity:0;transform:translateY(10px);transition:opacity .22s,transform .22s}
    .toast.show{opacity:1;transform:translateY(0)}

    /* extra animations for page elements */
    .card.entrance{opacity:0;transform:translateY(18px) scale(.995);transition:opacity .5s ease,transform .5s cubic-bezier(.2,.9,.3,1)}
    .card.entrance.visible{opacity:1;transform:translateY(0) scale(1)}
    .logo.pulse{animation:pulse 2.4s infinite}
    @keyframes pulse{0%{box-shadow:0 6px 18px rgba(0,194,168,.12)}50%{box-shadow:0 14px 30px rgba(0,194,168,.18)}100%{box-shadow:0 6px 18px rgba(0,194,168,.12)}}

    /* subtle hover effects */
    .holding:hover{transform:translateY(-4px);transition:transform .18s}
    .dot{transition:transform .18s}
    .legend .item:hover .dot{transform:scale(1.2)}

    /* bottom action bar */
    .bottom-actions{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:1200;display:flex;gap:12px;align-items:center;padding:8px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,0.02)}
    .action-button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .action-button.buy{background:linear-gradient(90deg,var(--accent),#17e6b1);color:#012}
    .action-button.sell{background:linear-gradient(90deg,#ff9a9a,#ff6b6b);color:#1a0a0a}
    .action-button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

    </style>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Inject modals + toast container
        const html = 
            <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
                <div id="modal" class="modal" role="dialog" aria-modal="true">
                    <button id="modalClose" class="btn-ghost-small" style="float:right">✕</button>
                    <h4 id="modalTitle"></h4>
                    <div id="modalBody"></div>
                    <div class="actions" id="modalActions"></div>
                </div>
            </div>
            <div class="fab-wrap" id="fabWrap" aria-hidden="false">
                <button id="fabMain" class="fab-main" aria-label="Open quick actions">+</button>
                <button title="Buy" data-action="buy" class="fab-mini" aria-label="Buy">Buy</button>
                <button title="Sell" data-action="sell" class="fab-mini" aria-label="Sell">Sell</button>
                <button title="Deposit" data-action="deposit" class="fab-mini" aria-label="Deposit">Deposit</button>
                <button title="Withdraw" data-action="withdraw" class="fab-mini" aria-label="Withdraw">Withdraw</button>
            </div>
            <div id="toast" class="toast" role="status" aria-live="polite"></div>
        ;
        const holder = document.createElement('div'); holder.innerHTML = html;
        document.body.appendChild(holder);

        const overlay = document.getElementById('modalOverlay');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalActions = document.getElementById('modalActions');
        const modalClose = document.getElementById('modalClose');
        const toast = document.getElementById('toast');
        const fabWrap = document.getElementById('fabWrap');
        const fabMain = document.getElementById('fabMain');

        function showToast(msg){
            toast.textContent = msg;
            toast.classList.add('show');
            clearTimeout(toast._t);
            toast._t = setTimeout(()=> toast.classList.remove('show'), 2200);
        }

        function readableAction(type){
            return ({ buy:'Buy', sell:'Sell', deposit:'Deposit', withdraw:'Withdraw' })[type] || 'Action';
        }

        function openModal(type){
            modalTitle.textContent = readableAction(type);

            // build simple body per type
            let body = '';
            if(type === 'buy' || type === 'sell'){
                body = `
                    <label>Ticker</label><input class="input" id="m_ticker" placeholder="e.g. CSE" />
                    <div class="row"><div style="flex:1"><label>Quantity</label><input type="number" min="1" id="m_qty" class="input" /></div>
                    <div style="width:120px"><label>Limit (LKR)</label><input type="number" min="0" id="m_price" class="input" /></div></div>
                `;
            } else {
                body = `
                    <label>Amount (LKR)</label><input type="number" min="0" id="m_amount" class="input" />
                    <label>Reference (optional)</label><input id="m_ref" class="input" />
                `;
            }
            modalBody.innerHTML = body;

            modalActions.innerHTML = `
                <button id="modalCancel" class="btn-ghost-small">Cancel</button>
                <button id="modalConfirm" class="btn-confirm">${readableAction(type)}</button>
            `;

            // show overlay + modal
            overlay.classList.add('show');
            modal.classList.add('show');

            // focus first input
            const first = modal.querySelector('input');
            if(first) first.focus();

            // handlers
            document.getElementById('modalCancel').onclick = closeModal;
            document.getElementById('modalConfirm').onclick = () => {
                // basic visual feedback + close
                showToast(`${readableAction(type)} submitted`);
                const btn = document.getElementById('modalConfirm');
                btn.disabled = true;
                btn.style.transform = 'scale(.98)';
                setTimeout(()=>{ btn.disabled = false; btn.style.transform = ''; closeModal(); }, 700);
            };
        }

        function closeModal(){
            modal.classList.remove('show');
            overlay.classList.remove('show');
        }

        modalClose.addEventListener('click', closeModal);
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });

        // FAB behavior
        fabMain.addEventListener('click', ()=> fabWrap.classList.toggle('fab-open'));
        fabWrap.querySelectorAll('.fab-mini').forEach(btn=>{
            btn.addEventListener('click', ()=> {
                const a = btn.getAttribute('data-action');
                openModal(a);
                fabWrap.classList.remove('fab-open');
            });
        });

        // Replace existing inline onclicks (buttons) to open modals instead of navigating
        // Support common variants and minor typos (withdrawal/withdraw)
        const map = [
            {patterns: [/onBuy\\s*\\(\\)/i, /on_buy\\s*\\(\\)/i, /buyNow\\s*\\(\\)/i, /onBuy/i], action: 'buy'},
            {patterns: [/onSell\\s*\\(\\)/i, /on_sell\\s*\\(\\)/i, /sellNow\\s*\\(\\)/i, /onSell/i], action: 'sell'},
            {patterns: [/onDeposit\\s*\\(\\)/i, /depositFunds\\s*\\(\\)/i, /onDeposit/i], action: 'deposit'},
            {patterns: [/onWithdraw\\s*\\(\\)/i, /onWithdrawal\\s*\\(\\)/i, /withdrawFunds\\s*\\(\\)/i, /onWithdraw/i], action: 'withdraw'}
        ];
        document.querySelectorAll('button[onclick]').forEach(b=>{
            const attr = b.getAttribute('onclick') || '';
            for(const m of map){
                if(m.patterns.some(rx => rx.test(attr))){
                    b.removeAttribute('onclick');
                    // update visuals: ensure consistent label if button is one of the action buttons
                    if(b.classList.contains('btn-buy')) b.textContent = 'Buy';
                    if(b.classList.contains('btn-sell')) b.textContent = 'Sell';
                    if(b.classList.contains('btn-ghost') && /deposit/i.test(attr)) b.textContent = 'Deposit';
                    if(b.classList.contains('btn-ghost') && /withdraw/i.test(attr)) b.textContent = 'Withdraw';

                    b.addEventListener('click', (ev)=>{ ev.preventDefault(); openModal(m.action); });
                    break;
                }
            }
        });

        // wire any bottom action buttons (new ones) that use data-action
        document.querySelectorAll('.action-button[data-action]').forEach(b=>{
            b.addEventListener('click', (e)=>{ e.preventDefault(); const a = b.dataset.action; openModal(a); });
        });

        // Entrance animation for cards (staggered)
        const cards = Array.from(document.querySelectorAll('.card'));
        cards.forEach(c => c.classList.add('entrance'));
        cards.forEach((c,i) => setTimeout(()=> c.classList.add('visible'), 80 * i + 120));

        // keyboard: Escape closes modal
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
    });
    </script>
    <style>
        :root{
            --bg:#0f1724;
            --card:#0b1220;
            --muted:#9aa4b2;
            --accent:#00c2a8;
            --accent-2:#6dd3ff;
            --danger:#ff6b6b;
            --glass: #1b2842ff;
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#071028 0%, #051521 100%);color:#e6eef6}
        .container{max-width:1200px;margin:28px auto;padding:20px;padding-bottom:140px;} /* extra bottom padding for fixed actions */
        /* NAV */
        .nav{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;backdrop-filter: blur(8px);box-shadow:0 6px 30px rgba(2,6,23,.6)}
        .brand{display:flex;gap:12px;align-items:center}
        .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#012;box-shadow:0 6px 18px rgba(0,194,168,.12)}
        .nav .links{display:flex;gap:14px;align-items:center;color:var(--muted)}
        .nav button{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer}
        /* GRID */
        .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;margin-top:18px}
        .col-4{grid-column:span 4}
        .col-8{grid-column:span 8}
        .col-6{grid-column:span 6}
        .card{margin:8px 0 8px 0;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,0.02)}
        .card h3{margin:0 0 8px 0;font-size:14px;color:var(--muted)}
        .stat{font-size:24px;font-weight:600}
        /* ACTIONS */
        .actions{display:flex;gap:10px;margin-top:12px}
        .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
        .btn-buy{background:linear-gradient(90deg,var(--accent),#17e6b1);color:#012}
        .btn-sell{background:linear-gradient(90deg,#ff9a9a,#ff6b6b);color:#1a0a0a}
        .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
        /* CHARTS */
        .chart-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
        canvas{width:100% !important;height:250px !important}
        .legend{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        .legend .item{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
        .dot{width:12px;height:12px;border-radius:3px}
        /* portfolio details */
        .portfolio-list{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:auto;padding-right:6px}
        .holding{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}
        .holding .left{display:flex;gap:10px;align-items:center}
        .avatar{width:38px;height:38px;border-radius:8px;background:linear-gradient(135deg,#fff2, #fff1);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--accent)}
        .muted{color:var(--muted);font-size:13px}
        /* responsive */
        @media (max-width:900px){
            .col-4,.col-6,.col-8{grid-column:span 12}
            canvas{height:220px !important}
            .nav{flex-direction:column;align-items:flex-start;gap:8px}
        }
        /* make pie area square for perfect circle on smaller screens */
        .pie-square{width:260px;height:260px;max-width:100%;display:flex;align-items:center;justify-content:center}
    </style>
</head>
<body>
    <div class="container">
        <nav class="nav">
            <div class="brand">
                <div class="logo">CSE</div>
                <div>
                    <div style="font-weight:700">Colombo Stock Exchange</div>
                    <div style="font-size:12px;color:var(--muted)">Portfolio dashboard</div>
                </div>
            </div>
            <div class="links">
                {% comment %} <div class="muted">Welcome, {{ user.get_full_name|default:request.user.username }}   </div>
                <button onclick="location.href='{% url 'portfolio:add' %}'">New Order</button>
                <button onclick="location.href='{% url 'account:logout' %}'">Sign out</button> {% endcomment %}
            </div>
        </nav>

        <div>
            <!-- LEFT: summary cards (removed Profit/Loss card as requested) -->
            <div class="col-4">
                <div class="card">
                    <h3>Total Assets</h3>
                    {% comment %} <div class="stat">LKR {{ assets|default:'0.00' }}</div> {% endcomment %}
                    <div class="muted">Current portfolio market value</div>
                    <!-- deposit/withdraw moved to bottom fixed action bar -->
                </div>
                <div class="card">
                    <h3>Total Profit</h3>
                    {% comment %} <div class="stat">LKR {{ assets|default:'0.00' }}</div> {% endcomment %}
                    <div class="muted">Profit</div>
                    <!-- deposit/withdraw moved to bottom fixed action bar -->
                </div>
                
            </div>

            <!-- RIGHT: charts -->
            <div class="col-8">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div>
                            <h3>Portfolio Allocation</h3>
                            <div class="muted">Sector & stock breakdown</div>
                        </div>
                        <div class="muted">Updated: {{ last_updated|default:"-" }}</div>
                    </div>

                    <div style="display:flex;gap:20px;align-items:center;margin-top:12px;flex-wrap:wrap">
                        <div style="flex:1;min-width:260px" class="chart-wrap">
                            <div class="pie-square">
                                <canvas id="pieChart" style="width:260px;height:260px;" ></canvas>
                            </div>
                            <div class="legend" id="pieLegend"></div>
                        </div>

                        <div style="flex:1;min-width:300px">
                            <h3 style="margin-bottom:8px">Detailed Portfolio</h3>
                            <div class="muted" style="margin-bottom:8px">Holdings, quantities and unrealized P/L</div>
                            <div class="portfolio-list" id="portfolioList">
                                {{ holdings.JKH.N0000}}
                                {% for h in holdings %}
                                    <div class="holding">
                                        <div class="left">
                                            <div class="avatar">{{ h.symbol|slice:":2"|upper }}</div>
                                            <div>
                                                <div style="font-weight:600">{{ h.symbol }} — {{ h.name }}</div>
                                                <div class="muted">{{ h.total_qty }} shares · Avg LKR {{ h.avg_cost }}</div>
                                            </div>
                                        </div>
                                        <div style="text-align:right">
                                            <div style="font-weight:700">LKR {{ h.current_price }}</div>
                                            <div class="muted" style="color:{{ h.pl_color|default:'#6dd3ff' }}">{{ h.unrealized_pl }}</div>
                                        </div>
                                    </div>
                                {% empty %}
                                    <div class="muted">No holdings yet. Buy your first stock to see details.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Portfolio Performance card removed as requested -->
            </div>
        </div>
    </div>

    <!-- bottom fixed action bar (moved action buttons to bottom) -->
    <div class="bottom-actions" style= 'position: fixed; bottom: 0; width: 100%; background: var(--glass); padding: 12px 0; z-index: 1000' aria-hidden="false">
        <button class="action-button buy" style="margin: 0 auto;" data-action="buy">Buy</button>
        <button class="action-button sell" style="margin: 0 auto;" data-action="sell">Sell</button>
        <button class="action-button ghost" style="margin: 0 auto;" data-action="deposit">Deposit</button>
        <button class="action-button ghost" style="margin: 0 auto;" data-action="withdraw">Withdraw</button>
    </div>

    <!-- Data shim: server should pass pie_data, pie_labels as JSON-like lists -->
    <script>
        // Template-provided data (replace in view context)
        const pieData = {{ pie_data|default:"[30, 25, 20, 15, 10]"|safe }};
        const pieLabels = {{ pie_labels|default:"['Banks','Manufacturing','Energy','Finance','Other']"|safe }};
        const pieColors = ['#00c2a8','#6dd3ff','#ffb86b','#ff6b6b','#9b8cff'];

        // PIE chart (clearer visuals, perfect circle)
        const PIE = document.getElementById('pieChart').getContext('2d');
        const pie = new Chart(PIE, {
            type: 'doughnut',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: pieColors,
                    borderColor: '#0b1220', // thin border for separation
                    borderWidth: 2,
                    hoverOffset: 14
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 1,            // enforce perfect circle
                cutout: '55%',            // visual hole size for clarity
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx){
                                const v = ctx.parsed;
                                const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
                                const pct = total ? (v/total*100).toFixed(1) : '0.0';
                                return `${ctx.label}: ${v} (${pct}%)`;
                            }
                        }
                    }
                },
                animation: { animateScale: true, duration: 700, easing: 'easeOutQuart' }
            }
        });

        // build legend (clearer text and percent)
        const legendEl = document.getElementById('pieLegend');
        legendEl.innerHTML = '';
        const total = pie.data.datasets[0].data.reduce((a,b)=>a+b,0);
        pie.data.labels.forEach((l,i)=>{
            const val = pie.data.datasets[0].data[i];
            const pct = total ? (val/total*100).toFixed(1) : '0.0';
            const item = document.createElement('div'); item.className='item';
            const dot = document.createElement('span'); dot.className='dot'; dot.style.background = pie.data.datasets[0].backgroundColor[i];
            item.appendChild(dot);
            const txt = document.createElement('span'); txt.textContent = `${l} · ${val} (${pct}%)`;
            item.appendChild(txt);
            legendEl.appendChild(item);
        });

        // Note: portfolio performance and profit spark charts removed per request.
    </script>
</body>
</html>
